name: Live Wire (6-hourly)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: live-wire
  cancel-in-progress: false

jobs:
  live-wire:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version-file: .python-version
          allow-prereleases: true
          cache: pip

      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt

      - name: Install AWS CLI
        run: |
          if ! command -v aws &>/dev/null; then
            curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip
            unzip -q /tmp/awscliv2.zip -d /tmp
            sudo /tmp/aws/install
          fi
          aws --version

      - name: Download state from R2
        run: |
          mkdir -p data/live_wire
          aws s3 cp "s3://$R2_BUCKET/state/live_wire_state.json" data/live_wire/state.json \
            --endpoint-url "https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com" || echo "No prior state (first run)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}

      - name: Run Live Wire
        run: python -m src.ingest.live_wire.runner
        env:
          PYTHONPATH: .
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

      - name: Upload latest to R2
        run: |
          aws s3 cp data/live_wire/latest.json "s3://$R2_BUCKET/latest/live_wire_state.json" \
            --endpoint-url "https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com" \
            --cache-control "public, max-age=300, stale-while-revalidate=60"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}

      - name: Upload state to R2
        run: |
          aws s3 cp data/live_wire/state.json "s3://$R2_BUCKET/state/live_wire_state.json" \
            --endpoint-url "https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}

      - name: Upload snapshots to R2
        run: |
          if ls data/live_wire/snapshots/*.jsonl.gz 1>/dev/null 2>&1; then
            aws s3 cp data/live_wire/snapshots/ "s3://$R2_BUCKET/snapshots/" \
              --endpoint-url "https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com" \
              --recursive --include "*.jsonl.gz"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
