IRAN CRISIS SIMULATOR - SYSTEM ARCHITECTURE
==========================================

┌───────────────────────────────────────────────────────────────────────────────┐
│                          INPUT: New Intelligence                               │
│                      (Deep Research Query Results)                            │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Parse & Structure
                                    ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│ LAYER 1: INTELLIGENCE PIPELINE                                                │
│ ============================================================================= │
│                                                                               │
│  Evidence Docs          Claims Ledger         Compiled Intel                 │
│  ┌─────────────┐       ┌──────────────┐      ┌────────────────┐            │
│  │ - Source    │──────▶│ - claim_id   │─────▶│ - Schema v2.0  │            │
│  │ - URL       │       │ - path       │      │ - Sources[]    │            │
│  │ - Date      │       │ - value      │      │ - Metadata     │            │
│  │ - Raw text  │       │ - source_ids │      │ - Triangulated │            │
│  │ - Grade A-D │       │ - confidence │      │                │            │
│  └─────────────┘       └──────────────┘      └────────────────┘            │
│                              │                                                │
│                              │ Merge (best source wins)                       │
│                              │ QA Gates (validate)                            │
│                              ▼                                                │
│                    iran_crisis_intel.json                                     │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Analyst reviews intel
                                    ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│ LAYER 2: PROBABILITY ESTIMATION                                               │
│ ============================================================================= │
│                                                                               │
│  Security Analyst Agent           Priors Contract                            │
│  ┌────────────────────┐           ┌───────────────────────────┐             │
│  │ - Reviews intel    │──────────▶│ - Resolve time semantics  │             │
│  │ - Estimates probs  │           │ - Fill defaults           │             │
│  │ - Provides reasons │           │ - Validate constraints    │             │
│  │ - Uncertainty      │           │ - Emit QA report          │             │
│  │   (low/mode/high)  │           │                           │             │
│  └────────────────────┘           └───────────────────────────┘             │
│           │                                      │                            │
│           ▼                                      ▼                            │
│  analyst_priors.json                   priors_resolved.json                  │
│  ┌────────────────────────┐            priors_qa.json                        │
│  │ probability: {         │            ┌────────────────┐                    │
│  │   low: 0.25,          │            │ errors: []     │                    │
│  │   mode: 0.4,          │            │ warnings: [...] │                    │
│  │   high: 0.6,          │            │ status: OK     │                    │
│  │   time_basis: "window"│            └────────────────┘                    │
│  │   anchor: "crackdown" │                                                   │
│  │   window_days: 14     │                                                   │
│  │ }                     │                                                   │
│  └────────────────────────┘                                                   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Run Monte Carlo
                                    ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│ LAYER 3: MONTE CARLO SIMULATION                                               │
│ ============================================================================= │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ FOR EACH RUN (10,000 times):                                         │   │
│  │                                                                        │   │
│  │   1. Sample priors once (cache per run)                              │   │
│  │      - P(defection) ~ Beta-PERT(0.03, 0.08, 0.15) = 0.076 this run  │   │
│  │                                                                        │   │
│  │   2. FOR EACH DAY (1 to 90):                                         │   │
│  │                                                                        │   │
│  │      a) Check Khamenei death                                         │   │
│  │         - Independent event, daily hazard                            │   │
│  │                                                                        │   │
│  │      b) Update protest state                                         │   │
│  │         - DECLINING ─▶ STABLE ─▶ ESCALATING ─▶ ORGANIZED            │   │
│  │         - Or: ─▶ COLLAPSED (terminal)                               │   │
│  │                                                                        │   │
│  │      c) Check regime transitions                                     │   │
│  │         ┌──────────────────────────────────────┐                     │   │
│  │         │ If protests ESCALATING AND           │                     │   │
│  │         │    day ∈ [escalation_start,          │                     │   │
│  │         │           escalation_start + 29]:    │                     │   │
│  │         │   Apply crackdown hazard             │                     │   │
│  │         └──────────────────────────────────────┘                     │   │
│  │                                                                        │   │
│  │      d) Check defection                                              │   │
│  │         - Only if protests ACTIVE                                    │   │
│  │         - Only within window [t0+30, t0+89]                          │   │
│  │                                                                        │   │
│  │      e) Check ethnic uprising                                        │   │
│  │         - Coordination event                                         │   │
│  │         - Then: fragmentation window opens                           │   │
│  │                                                                        │   │
│  │      f) Update US posture                                            │   │
│  │         ┌──────────────────────────────────────┐                     │   │
│  │         │ If CRACKDOWN AND                     │                     │   │
│  │         │    day ∈ [crackdown_start,           │                     │   │
│  │         │           crackdown_start + 13]:     │                     │   │
│  │         │   Apply cyber hazard                 │                     │   │
│  │         │   Apply kinetic hazard               │                     │   │
│  │         └──────────────────────────────────────┘                     │   │
│  │                                                                        │   │
│  │      g) Check terminal outcomes                                      │   │
│  │         - COLLAPSE, TRANSITION, FRAGMENTATION, SUPPRESSED            │   │
│  │                                                                        │   │
│  │   3. Record outcome & events                                         │   │
│  │                                                                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ AGGREGATE RESULTS:                                                    │   │
│  │                                                                        │   │
│  │  Outcome Distribution:                                               │   │
│  │    REGIME_SURVIVES_STATUS_QUO: 82.0% ───────────■                   │   │
│  │    MANAGED_TRANSITION: 5.5% ─■                                       │   │
│  │    REGIME_SURVIVES_WITH_CONCESSIONS: 5.5% ─■                         │   │
│  │    REGIME_COLLAPSE_CHAOTIC: 5.0% ■                                   │   │
│  │    ETHNIC_FRAGMENTATION: 2.0% ■                                      │   │
│  │                                                                        │   │
│  │  Event Rates:                                                         │   │
│  │    us_intervention: 86.0%                                            │   │
│  │    security_force_defection: 3.0%                                    │   │
│  │    khamenei_death: 8.5%                                              │   │
│  │    ethnic_uprising: 10.0%                                            │   │
│  │                                                                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Generate visuals
                                    ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│ LAYER 4: VISUALIZATION & ANALYSIS                                             │
│ ============================================================================= │
│                                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────┐            │
│  │ Outcome Chart   │  │ Iran Map (SVG)  │  │ Event Timeline   │            │
│  │ (PNG)           │  │                 │  │ (Markdown)       │            │
│  │                 │  │  Tehran ●       │  │                  │            │
│  │    ██████ 82%   │  │  Isfahan ●      │  │ Day 15: Crackdown│            │
│  │    ██ 5.5%      │  │  Tabriz ●       │  │ Day 22: Cyber    │            │
│  │    ██ 5.5%      │  │                 │  │ Day 45: Collapse │            │
│  │    ██ 5.0%      │  │                 │  │                  │            │
│  │    █ 2.0%       │  │                 │  │                  │            │
│  └─────────────────┘  └─────────────────┘  └──────────────────┘            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘


KEY INNOVATIONS
===============

1. TIME WINDOW SEMANTICS
   ┌─────────────────────────────────────────────────────────────────┐
   │ Problem: "30% within 14 days" applied as 30% daily forever      │
   │ Solution: Explicit window with anchor + offset + length         │
   │                                                                  │
   │ Before: ████████████████████████████████████ (cumulative 99.9%) │
   │ After:  ──────────████████────────────────── (correct 30%)      │
   │                   ↑                                              │
   │                   crackdown_start_day                            │
   │                   (14-day window)                                │
   └─────────────────────────────────────────────────────────────────┘

2. AUDITABLE EVIDENCE CHAIN
   ┌─────────────────────────────────────────────────────────────────┐
   │ Every number has:                                                │
   │  • Source (Reuters A1, OSINT B3, etc.)                          │
   │  • Timestamp (when published, retrieved)                         │
   │  • Triangulation status (single source vs confirmed)            │
   │  • Null reason (if data missing: NOT_APPLICABLE, etc.)          │
   │                                                                  │
   │ Result: "Where did 0.08 come from?" → Traceable to intel file   │
   └─────────────────────────────────────────────────────────────────┘


CRITICAL COMPONENTS
===================

┌─────────────────────────────────────────────────────────────────────────┐
│ SimulationState (per run)                                               │
│ ──────────────────────────────────────────────────────────────────────  │
│  • day: 1..90                                                           │
│  • regime_state: STATUS_QUO, ESCALATING, CRACKDOWN, COLLAPSE, ...      │
│  • protest_state: DECLINING, STABLE, ESCALATING, ORGANIZED, COLLAPSED  │
│  • us_posture: RHETORICAL → ... → KINETIC → GROUND (monotonic)         │
│                                                                          │
│  • Anchor days (set dynamically when event occurs):                     │
│    - escalation_start_day                                               │
│    - crackdown_start_day                                                │
│    - defection_day                                                       │
│    - ethnic_uprising_day                                                │
│    - khamenei_death_day                                                 │
│    - collapse_day                                                        │
│                                                                          │
│  • Terminal outcome: "REGIME_SURVIVES_STATUS_QUO", etc.                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ Key Functions                                                            │
│ ──────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  _window_active(state, prob_obj) → bool                                 │
│    ├─ anchor_day = state.crackdown_start_day                            │
│    ├─ start = anchor_day + start_offset_days                            │
│    ├─ end = start + window_days - 1                                     │
│    └─ return start <= day <= end                                        │
│                                                                          │
│  _daily_hazard_from_window_prob(p_window, window_days) → float          │
│    └─ return 1 - (1 - p_window)^(1/window_days)                         │
│                                                                          │
│  _protests_active_for_30d_condition(state) → bool                       │
│    └─ return state.protest_state in {STABLE, ESCALATING}                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘


TESTING
=======

┌─────────────────────────────────────────────────────────────────────────┐
│ 6 Unit Tests (All Passing)                                              │
│ ──────────────────────────────────────────────────────────────────────  │
│  ✓ Window boundary (3-day window: days 5,6,7 active, not 8)            │
│  ✓ Anchor day setting (entering CRACKDOWN sets crackdown_start_day)    │
│  ✓ Window enforcement (cyber NOT before crackdown_start_day)           │
│  ✓ Condition checking (defection NOT when protests DECLINING)          │
│  ✓ Contract validation (missing prior → error)                         │
│  ✓ Prior-driven outcomes (fragmentation uses prior, not 0.3)           │
└─────────────────────────────────────────────────────────────────────────┘


FILES
=====

src/simulation.py                913 lines   Core Monte Carlo engine
src/priors/contract.py           180 lines   Priors resolver + QA
src/pipeline/models.py            62 lines   Evidence/Claims models
src/pipeline/compile_intel.py    129 lines   Claims compiler
src/pipeline/qa.py                62 lines   Quality gates
tests/test_time_semantics.py     111 lines   Unit tests
                                ─────────
                                1457 lines   Total production code


STATUS
======

✅ All tests passing
✅ Simulation runs successfully (200 iterations in ~2 seconds)
✅ QA report: 0 errors, 3 warnings (naming mismatches)
✅ No TODOs, FIXMEs, or HACKs in codebase
✅ Ready for production use with real intelligence data
